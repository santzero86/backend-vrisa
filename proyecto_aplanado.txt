Estructura y contenido del proyecto en: C:\Users\santz\Desktop\BackendDataBaseProject
================================================================================

    - .gitignore
--------------------------------------------------------------------------------
// Ruta del archivo: .gitignore
--------------------------------------------------------------------------------
vrisa_env
*.pyc
__pycache__/
db.sqlite3
*.log
*.swp
*.DS_Store
/media
/static
/venv

================================================================================

    - Dockerfile
--------------------------------------------------------------------------------
// Ruta del archivo: Dockerfile
--------------------------------------------------------------------------------
FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Directorio de trabajo dentro del contenedor
WORKDIR /app

# Instalar dependencias
COPY requirements.txt /app/
RUN pip install --no-cache-dir -r requirements.txt

COPY . /app/

# Establecer permisos de ejecuci√≥n para el script de entrada
COPY entrypoint.sh /app/
RUN chmod +x /app/entrypoint.sh

ENTRYPOINT ["sh", "/app/entrypoint.sh"]
EXPOSE 8000

CMD ["python", "manage.py", "runserver", "0.0.0.0:8000"]

================================================================================

    - README.md
--------------------------------------------------------------------------------
// Ruta del archivo: README.md
--------------------------------------------------------------------------------
Primero instala el paquete obligatorio:
```
sudo apt install python3-venv -y
```

Desde tu carpeta backend-vrisa:
```
python3 -m venv vrisa_env
```

Activar el entorno virtual
```
source vrisa_env/bin/activate
```
Cuando est√© activo, ver√°s algo como:

(venv) pepito@...

4. Instalar Django dentro del venv
```
pip install django djangorestframework
pip install -r requirements.txt
```


### Levantar el proyecto desde un contenedor Docker
```
# Si es la primera vez, debe construirse la imagen
docker compose up --build -d

# En proximas veces, basta con levantar el contenedor
docker compose up -d
```

###  Ejecucion de Migraciones 
```
# Correr las migraciones dentro del contenedor 'backend'
docker-compose exec backend python manage.py makemigrations
docker-compose exec backend python manage.py migrate

# Crear superusuario dentro del contenedor
docker-compose exec backend python manage.py createsuperuser
```


(vrisa_env) pepito@~    python manage.py createsuperuser
Direcci√≥n de correo: admin@vrisa.com
First name: Admin
Last name: Vrisa
Password: 
Password (again): 
Superuser created successfully.


### Comandos de Django para crear una nueva app o inicializar la aplicacion

```
python manage.py startapp nombre_app

python manage.py runserver
```


================================================================================

    - aplanador.py
--------------------------------------------------------------------------------
// Ruta del archivo: aplanador.py
--------------------------------------------------------------------------------
import os

def aplanar_proyecto(ruta_proyecto, archivo_salida="proyecto_aplanado.txt"):
    """
    Recorre un directorio de proyecto y guarda la estructura y el contenido
    de los archivos en un √∫nico archivo de texto.

    :param ruta_proyecto: La ruta al directorio ra√≠z del proyecto.
    :param archivo_salida: El nombre del archivo donde se guardar√° el resultado.
    """

    # --- Configuraci√≥n de Exclusiones ---
    # Agrega aqu√≠ los nombres de directorios que quieres ignorar.
    directorios_ignorados = {
        'node_modules',
        'vrisa_env',
        'venv',
        'env',
        '.git',
        '__pycache__',
        'migrations',
        'media',
        'static_root',
        '.vscode',
        '.idea',
    }

    # Agrega aqu√≠ las extensiones de archivo que quieres ignorar.
    extensiones_ignoradas = {
        '.pyc',
        '.log',
        '.sqlite3',
        '.db',
        '.DS_Store',
        '.env',
        '.svg',
        '.png',
        '.jpg',
        '.jpeg',
        '.gif',
    }
    
    # Agrega aqu√≠ nombres de archivos espec√≠ficos a ignorar.
    archivos_ignorados = {
        'manage.py', # Generalmente no es necesario para entender la l√≥gica principal
        archivo_salida # Para no incluir el propio archivo de salida
    }

    try:
        with open(archivo_salida, "w", encoding="utf-8") as salida:
            salida.write(f"Estructura y contenido del proyecto en: {os.path.abspath(ruta_proyecto)}\n")
            salida.write("=" * 80 + "\n\n")

            for ruta_actual, dirs, files in os.walk(ruta_proyecto):
                # Ignorar directorios no deseados
                dirs[:] = [d for d in dirs if d not in directorios_ignorados]

                # Obtener la ruta relativa para una mejor visualizaci√≥n
                ruta_relativa = os.path.relpath(ruta_actual, ruta_proyecto)
                if ruta_relativa == ".":
                    ruta_relativa = "" # Para el directorio ra√≠z

                # Escribir la estructura del directorio
                nivel_profundidad = ruta_relativa.count(os.sep)
                prefijo = "    " * nivel_profundidad
                if ruta_relativa:
                    salida.write(f"{prefijo}[{os.path.basename(ruta_actual)}/]\n")

                # Procesar archivos en el directorio actual
                for nombre_archivo in sorted(files):
                    # Comprobar si el archivo debe ser ignorado
                    if nombre_archivo in archivos_ignorados:
                        continue
                    if os.path.splitext(nombre_archivo)[1].lower() in extensiones_ignoradas:
                        continue

                    # Escribir el nombre del archivo
                    salida.write(f"{prefijo}    - {nombre_archivo}\n")
                    
                    try:
                        ruta_completa_archivo = os.path.join(ruta_actual, nombre_archivo)
                        
                        # Escribir la cabecera del contenido del archivo
                        salida.write("-" * 80 + "\n")
                        salida.write(f"// Ruta del archivo: {os.path.join(ruta_relativa, nombre_archivo).replace(os.sep, '/')}\n")
                        salida.write("-" * 80 + "\n")
                        
                        # Leer y escribir el contenido del archivo
                        with open(ruta_completa_archivo, "r", encoding="utf-8", errors="ignore") as archivo:
                            contenido = archivo.read()
                            salida.write(contenido)
                        
                        salida.write("\n\n" + "=" * 80 + "\n\n")

                    except Exception as e:
                        salida.write(f"// No se pudo leer el archivo: {nombre_archivo}. Error: {e}\n\n")
        
        print(f"¬°√âxito! El proyecto ha sido aplanado en el archivo: {archivo_salida}")

    except Exception as e:
        print(f"Ocurri√≥ un error al generar el archivo: {e}")


if __name__ == "__main__":
    # La ruta del proyecto es el directorio actual donde se ejecuta el script.
    ruta_del_proyecto = os.getcwd() 
    
    # Llama a la funci√≥n para aplanar el proyecto.
    aplanar_proyecto(ruta_del_proyecto)

================================================================================

    - docker-compose.yml
--------------------------------------------------------------------------------
// Ruta del archivo: docker-compose.yml
--------------------------------------------------------------------------------
services:
  vrisa_db:
    image: postgres:15
    environment:
      POSTGRES_DB: vrisa_db
      POSTGRES_USER: vrisa_user
      POSTGRES_PASSWORD: local_password_1234
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
  
  backend:
    image: vrisa-backend:1.0.0
    build: .
    container_name: vrisa_backend
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      - .:/app
    ports:
      - "8000:8000"
    environment:
      - POSTGRES_DB=vrisa_db
      - POSTGRES_USER=vrisa_user
      - POSTGRES_PASSWORD=local_password_1234
      - POSTGRES_HOST=vrisa_db
    depends_on:
      - vrisa_db

volumes:
  pgdata:


================================================================================

    - entrypoint.sh
--------------------------------------------------------------------------------
// Ruta del archivo: entrypoint.sh
--------------------------------------------------------------------------------
#!/bin/sh
set -e

echo "Aplicando migraciones de base de datos..."
python manage.py migrate

exec "$@"

================================================================================

    - ingesta_datos_reales.py
--------------------------------------------------------------------------------
// Ruta del archivo: ingesta_datos_reales.py
--------------------------------------------------------------------------------
import requests
import time
from datetime import datetime

# ================= CONFIGURACI√ìN =================
WAQI_TOKEN = "5d29432e758a787d8c83242cfe4f4e4394ce0ac4"
WAQI_STATION_URL = f"https://api.waqi.info/feed/cali/?token={WAQI_TOKEN}"

# Configuraci√≥n de API Local (VriSA)
API_URL = "http://localhost:8000/api"
# Usuario y pass de un admin o usuario registrado en el sistema
VRISA_USER = "san@gmail.com" 
VRISA_PASS = "1234"

SENSOR_ID = 1  
VAR_MAP = {
    "pm25": 1,  # ID de PM2.5 en DB
    "t": 2,     # ID de Temperatura
    "h": 3      # ID de Humedad
}
# =================================================

def obtener_token_vrisa():
    """Se loguea en tu sistema para tener permiso de escribir datos"""
    try:
        resp = requests.post(f"{API_URL}/users/login/", json={
            "email": VRISA_USER,
            "password": VRISA_PASS
        })
        if resp.status_code == 200:
            return resp.json()['access']
        print(f"Error login VriSA: {resp.text}")
        return None
    except Exception as e:
        print(f"VriSA ca√≠do: {e}")
        return None

def correr_ingesta():
    print("--- Iniciando Servicio de Ingesta de Datos Reales (WAQI) ---")
    
    while True:
        # 1. Obtener Token fresco del backend
        jwt_token = obtener_token_vrisa()
        if not jwt_token:
            time.sleep(10)
            continue

        headers = {"Authorization": f"Bearer {jwt_token}"}

        try:
            # 2. Consultar datos reales a WAQI
            print(f"[{datetime.now().strftime('%H:%M:%S')}] Consultando API Mundial...")
            waqi_resp = requests.get(WAQI_STATION_URL).json()

            if waqi_resp['status'] == 'ok':
                datos = waqi_resp['data']['iaqi'] # 'iaqi' tiene los valores individuales
                
                # 3. Recorrer los datos y enviarlos a tu Backend
                for key, val_obj in datos.items():
                    if key in VAR_MAP:
                        payload = {
                            "sensor": SENSOR_ID,
                            "variable": VAR_MAP[key],
                            "value": float(val_obj['v']),
                            "measure_date": datetime.now().isoformat()
                        }
                        
                        # POST a tu endpoint de mediciones
                        res = requests.post(
                            f"{API_URL}/measurements/data/", 
                            json=payload, 
                            headers=headers
                        )
                        
                        if res.status_code == 201:
                            print(f"   > Guardado {key}: {val_obj['v']}")
                        else:
                            print(f"   > Error guardando {key}: {res.text}")
            else:
                print("   > Error en respuesta WAQI")

        except Exception as e:
            print(f"   > Error de conexi√≥n: {e}")

        # Esperar 5 minutos antes de la pr√≥xima consulta
        # (Los datos reales no cambian cada segundo)
        print("   > Esperando 5 minutos...")
        time.sleep(300) 

if __name__ == "__main__":
    correr_ingesta()

================================================================================

    - inicializar_datos.py
--------------------------------------------------------------------------------
// Ruta del archivo: inicializar_datos.py
--------------------------------------------------------------------------------
import os
import django

# Esto configura el entorno de Django para que el script funcione
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "config.settings")
django.setup()

from src.institutions.models import EnvironmentalInstitution
from src.stations.models import MonitoringStation
from src.measurements.models import VariableCatalog
from src.sensors.models import Sensor
from src.users.models import User

def run():
    print("--- Iniciando carga de datos base ---")

    # 1. Crear Instituci√≥n (DAGMA)
    inst, created = EnvironmentalInstitution.objects.get_or_create(
        institute_name="DAGMA - Cali",
        defaults={'physic_address': "Av. 5AN #20N-08, Cali"}
    )
    if created:
        print(f"‚úÖ Instituci√≥n creada: {inst.institute_name}")
    else:
        print(f"‚ÑπÔ∏è La instituci√≥n {inst.institute_name} ya exist√≠a")

    # 2. Crear Estaci√≥n Real (La Flora)
    station, created = MonitoringStation.objects.get_or_create(
        station_name="Estaci√≥n La Flora",
        defaults={
            'geographic_location_lat': 3.476,
            'geographic_location_long': -76.526,
            'institution': inst,
            'operative_status': 'ACTIVE'
        }
    )
    if created:
        print(f"‚úÖ Estaci√≥n creada: {station.station_name}")

    # 3. Crear Variables (PM2.5, Temperatura, Humedad)
    var_pm25, _ = VariableCatalog.objects.get_or_create(
        code="PM2.5",
        defaults={'name': "Material Particulado 2.5", 'unit': "¬µg/m¬≥", 'min_expected_value': 0, 'max_expected_value': 500}
    )
    var_temp, _ = VariableCatalog.objects.get_or_create(
        code="TEMP",
        defaults={'name': "Temperatura", 'unit': "¬∞C", 'min_expected_value': -10, 'max_expected_value': 50}
    )
    var_hum, _ = VariableCatalog.objects.get_or_create(
        code="HUM",
        defaults={'name': "Humedad", 'unit': "%", 'min_expected_value': 0, 'max_expected_value': 100}
    )
    print("‚úÖ Variables del cat√°logo aseguradas")

    # 4. Crear el Sensor Virtual para WAQI
    sensor, created = Sensor.objects.get_or_create(
        serial_number="WAQI-VIRTUAL-001",
        defaults={
            'model': 'API Gateway WAQI',
            'manufacturer': 'Virtual',
            'installation_date': '2024-01-01',
            'status': 'ACTIVE',
            'station': station
        }
    )
    if created:
        print(f"‚úÖ Sensor Virtual creado: {sensor.serial_number}")
    else:
        print(f"‚ÑπÔ∏è El sensor {sensor.serial_number} ya exist√≠a")

    print("\n=============================================")
    print(f"üìå DATOS PARA TU SCRIPT DE INGESTA:")
    print(f"   SENSOR_ID: {sensor.sensor_id}")
    print(f"   ID PM2.5 : {var_pm25.variable_id}")
    print(f"   ID TEMP  : {var_temp.variable_id}")
    print(f"   ID HUM   : {var_hum.variable_id}")
    print("=============================================")

if __name__ == "__main__":
    run()

================================================================================

    - requirements.txt
--------------------------------------------------------------------------------
// Ruta del archivo: requirements.txt
--------------------------------------------------------------------------------
asgiref==3.10.0
Django==5.2.8
django-cors-headers==4.3.1
djangorestframework==3.16.1
djangorestframework-simplejwt==5.3.1
psycopg2-binary
sqlparse==0.5.3
Pillow 
django-extensions


================================================================================

[common/]
    - _init_.py
--------------------------------------------------------------------------------
// Ruta del archivo: common/_init_.py
--------------------------------------------------------------------------------


================================================================================

    - exception_handler.py
--------------------------------------------------------------------------------
// Ruta del archivo: common/exception_handler.py
--------------------------------------------------------------------------------
from rest_framework.views import exception_handler
from rest_framework.response import Response

def custom_exception_handler(exc, context):
    """
    Manejador personalizado de excepciones para formatear errores de validaci√≥n
    de una manera m√°s legible para el cliente.
    """
    response = exception_handler(exc, context)

    # Si hay una respuesta y es un error de validaci√≥n (400 Bad Request)
    if response is not None and response.status_code == 400:
        data = response.data
        formatted_errors = []

        # Si 'data' es un diccionario (ej: {"email": ["Error 1"], "password": ["Error 2"]})
        if isinstance(data, dict):
            for field, errors in data.items():
                # Obtenemos el primer error de la lista si es una lista
                error_msg = errors[0] if isinstance(errors, list) else str(errors)
                
                # Caso especial: 'non_field_errors' (errores generales)
                if field == 'non_field_errors':
                    formatted_errors.append(error_msg)
                else:
                    # Formato legible: "Email: Error 1"
                    formatted_errors.append(f"{field.capitalize()}: {error_msg}")
            
            # Reemplazamos la data original con nuestro formato simple
            response.data = {
                "message": "\n".join(formatted_errors), # Un solo string con saltos de l√≠nea
                "original_errors": data # Mantenemos el original por si acaso (opcional)
            }
        
        # Si 'data' es una lista (ej: errores m√∫ltiples sin campo espec√≠fico)
        elif isinstance(data, list):
            response.data = {
                "message": data[0]
            }

    return response

================================================================================

    - exceptions.py
--------------------------------------------------------------------------------
// Ruta del archivo: common/exceptions.py
--------------------------------------------------------------------------------
# common/exceptions.py

from typing import Dict, Any

class ApplicationError(Exception):
    """
    Base exception class for the application.
    All custom exceptions should inherit from this class.
    """
    def __init__(self: 'ApplicationError', message: str) -> None:
        self.message: str = message
        super().__init__(self.message)

class NotFoundError(ApplicationError):
    """
    Raised when a requested resource is not found in the system.
    Corresponds to an HTTP 404 Not Found response.
    """
    pass

class ValidationError(ApplicationError):
    """
    Raised when input data fails validation checks.
    Corresponds to an HTTP 400 Bad Request response.
    It can hold a dictionary of field-specific errors.
    """
    def __init__(self: 'ValidationError', errors: Dict[str, Any]) -> None:
        self.errors: Dict[str, Any] = errors
        # Create a user-friendly message from the errors dictionary
        super().__init__("Input validation failed")

class ConflictError(ApplicationError):
    """
    Raised when an action cannot be completed because of a conflict
    with the current state of the resource.
    E.g., trying to create an item that already exists.
    Corresponds to an HTTP 409 Conflict response.
    """
    pass

class UnauthorizedError(ApplicationError):
    """
    Raised for authorization failures, e.g., a user trying to access
    a resource they do not have permission to view.
    Corresponds to an HTTP 403 Forbidden response.
    """
    pass


================================================================================

[config/]
    - __init__.py
--------------------------------------------------------------------------------
// Ruta del archivo: config/__init__.py
--------------------------------------------------------------------------------


================================================================================

    - asgi.py
--------------------------------------------------------------------------------
// Ruta del archivo: config/asgi.py
--------------------------------------------------------------------------------
"""
ASGI config for core project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_asgi_application()


================================================================================

    - settings.py
--------------------------------------------------------------------------------
// Ruta del archivo: config/settings.py
--------------------------------------------------------------------------------
import os
from datetime import timedelta
from pathlib import Path

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

# Ruta f√≠sica en el disco donde se guardar√°n los archivos subidos
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-1)9&^#b#y@vosi%tc@6tsetwuu1w%hmlnt^wk&wk#+63_%idp0'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = ["*"]


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'src.users.apps.UsersConfig',
    'src.institutions.apps.InstitutionsConfig',
    'src.stations.apps.StationsConfig',
    'src.sensors.apps.SensorsConfig',
    'src.measurements.apps.MeasurementsConfig',
    'rest_framework',
    'corsheaders',
    'django_extensions',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

# Configuraci√≥n de CORS
# Esto permite peticiones desde el frontend
CORS_ALLOWED_ORIGINS = [
    "http://localhost:8088", 
    "http://localhost:5173",
    "http://127.0.0.1:8088",
]

ROOT_URLCONF = 'config.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

# Configuraci√≥n de Django REST Framework
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'rest_framework_simplejwt.authentication.JWTAuthentication',
    ),
    'DEFAULT_PERMISSION_CLASSES': (
        'rest_framework.permissions.IsAuthenticated',
    ),
    'EXCEPTION_HANDLER': 'common.exception_handler.custom_exception_handler',
}


# Configuraci√≥n del token JWT
SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(minutes=60), # El token de acceso dura 1 hora
    'REFRESH_TOKEN_LIFETIME': timedelta(days=1),    # El de refresco dura 1 d√≠a
    'ROTATE_REFRESH_TOKENS': True,
    'BLACKLIST_AFTER_ROTATION': True,
    'UPDATE_LAST_LOGIN': True,                      # Actualiza last_login en la tabla user al loguearse
    'ALGORITHM': 'HS256',
    'SIGNING_KEY': SECRET_KEY,                     
    'AUTH_HEADER_TYPES': ('Bearer',),
    'AUTH_HEADER_NAME': 'HTTP_AUTHORIZATION',
    'USER_ID_FIELD': 'id',
    'USER_ID_CLAIM': 'user_id',
}

WSGI_APPLICATION = 'config.wsgi.application'


# Database
# https://docs.djangoproject.com/en/5.2/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': os.environ.get('POSTGRES_DB', 'vrisa_db'),
        'USER': os.environ.get('POSTGRES_USER', 'vrisa_user'),
        'PASSWORD': os.environ.get('POSTGRES_PASSWORD', 'local_password_1234'),
        'HOST': os.environ.get('POSTGRES_HOST', 'vrisa_db'),
        'PORT': os.environ.get('POSTGRES_PORT', '5432'),
    }
}


# Password validation
# https://docs.djangoproject.com/en/5.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/5.2/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/5.2/howto/static-files/

STATIC_URL = 'static/'

# Default primary key field type
# https://docs.djangoproject.com/en/5.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

AUTH_USER_MODEL = 'users.User'


================================================================================

    - urls.py
--------------------------------------------------------------------------------
// Ruta del archivo: config/urls.py
--------------------------------------------------------------------------------
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/users/', include('src.users.urls')), 
    path('api/institutions/', include('src.institutions.urls')),
    path('api/sensors/', include('src.sensors.urls')),  
    path('api/measurements/', include('src.measurements.urls')),
]


================================================================================

    - wsgi.py
--------------------------------------------------------------------------------
// Ruta del archivo: config/wsgi.py
--------------------------------------------------------------------------------
"""
WSGI config for core project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_wsgi_application()


================================================================================

[dataBase/]
[src/]
    - __init__.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/__init__.py
--------------------------------------------------------------------------------


================================================================================

    [institutions/]
        - __init__.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/institutions/__init__.py
--------------------------------------------------------------------------------


================================================================================

        - admin.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/institutions/admin.py
--------------------------------------------------------------------------------
from django.contrib import admin
from src.institutions.models import EnvironmentalInstitution, IntegrationRequest, InstitutionColorSet

class InstitutionColorSetInline(admin.TabularInline):
    """
    Permite la edici√≥n inline de colores dentro del panel de la Instituci√≥n.
    """
    model = InstitutionColorSet
    extra = 1

# Panel para Instituciones: B√∫squeda por nombre/email rep, filtro por fecha creaci√≥n.
@admin.register(EnvironmentalInstitution)
class EnvironmentalInstitutionAdmin(admin.ModelAdmin):
    """
    Configuraci√≥n del panel de administraci√≥n para Instituciones.
    Incluye b√∫squeda por representante y filtros de fecha.
    """
    list_display = ('institute_name', 'physic_address', 'created_at')
    search_fields = ('institute_name', 'representative__email')
    list_filter = ('created_at',)
    inlines = [InstitutionColorSetInline] 

# Panel para solicitudes: Visualiza estado y fechas. B√∫squeda por nombre de instituci√≥n asociada.
@admin.register(IntegrationRequest)
class IntegrationRequestAdmin(admin.ModelAdmin):
    """
    Configuraci√≥n del panel de administraci√≥n para Solicitudes.
    Visualiza el estado, fechas y qui√©n revis√≥ la solicitud.
    """
    list_display = ('institution', 'request_status', 'request_date', 'reviewed_by')
    search_fields = ('institution__institute_name',)
    list_filter = ('request_status', 'request_date')

================================================================================

        - apps.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/institutions/apps.py
--------------------------------------------------------------------------------
from django.apps import AppConfig

class InstitutionsConfig(AppConfig):
    '''
    Configuraci√≥n principal del m√≥dulo de Instituciones.
    Define el tipo de AutoField por defecto y el namespace 'src.institutions'.
    '''
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'src.institutions'
    label = 'institutions'


================================================================================

        - models.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/institutions/models.py
--------------------------------------------------------------------------------
from django.db import models
from django.conf import settings

User = settings.AUTH_USER_MODEL

class ValidationStatus(models.TextChoices):
    PENDING = 'PENDING', 'Pendiente de Validaci√≥n'
    ACCEPTED = 'ACCEPTED', 'Aceptada'
    REJECTED = 'REJECTED', 'Rechazada'

class EnvironmentalInstitution(models.Model):
    """
    Representa una entidad institucional dentro del sistema ambiental.    
    Esta clase act√∫a como el modelo principal para almacenar la informaci√≥n
    b√°sica, identidad visual y ubicaci√≥n de las instituciones aliadas.
    """
    institute_name = models.CharField(max_length=255, unique=True, verbose_name="Nombre de la Instituci√≥n")
    physic_address = models.CharField(max_length=255, verbose_name="Direcci√≥n F√≠sica")
    institute_logo = models.ImageField(
        upload_to='institution_logos/',
        null=True,
        blank=True,
        verbose_name="Logo"
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    validation_status = models.CharField(
        max_length=20,
        choices=ValidationStatus.choices,
        default=ValidationStatus.PENDING,
        verbose_name="Estado de Validaci√≥n"
    )
    
    def __str__(self):
        return self.institute_name
    
    class Meta:
        db_table = 'environmental_institution'
        verbose_name = "Instituci√≥n Ambiental"
        verbose_name_plural = "Instituciones Ambientales"
        ordering = ['institute_name']

# Atributo multivaluado para almacenar un conjunto de colores asociados a la instituci√≥n.
class InstitutionColorSet(models.Model):
    """
    Almacena la configuraci√≥n de colores corporativos de una instituci√≥n.
    Se utiliza para personalizar la interfaz de usuario seg√∫n la identidad
    visual de cada instituci√≥n. Permite una relaci√≥n uno a muchos.
    """
    institution = models.ForeignKey(
        EnvironmentalInstitution,
        on_delete=models.CASCADE,
        related_name='colors',
        verbose_name="Instituci√≥n"
    )

    color_hex = models.CharField(max_length=7, help_text="Formato hexadecimal, ej: #FF5733", verbose_name="Color Hex")
   # Esto asegura que una instituci√≥n no pueda tener el mismo color repetido.
    class Meta:
        unique_together = ('institution', 'color_hex')
        verbose_name = "Color de Instituci√≥n"

    def __str__(self):
        return f"{self.institution.institute_name} - {self.color_hex}"
    
    class Meta:
        db_table = 'institution_color_set'
        unique_together = ('institution', 'color_hex')
        verbose_name = "Color Institucional"
        verbose_name_plural = "Colores Institucionales"

class IntegrationRequest(models.Model):
    """
    Gestiona el ciclo de vida de una solicitud de integraci√≥n al sistema.
    Permite a una instituci√≥n solicitar el registro de estaciones y administradores.
    Incluye flujo de aprobaci√≥n por parte de un superadministrador.
    """
    # La instituci√≥n que hace la solicitud.
    institution = models.ForeignKey(
        EnvironmentalInstitution,
        on_delete=models.CASCADE, # Si se borra la instituci√≥n, se borran sus solicitudes.
        related_name='integration_requests',
        verbose_name="Instituci√≥n Solicitante"
    )

    #Administrador de la estaci√≥n a registrar
    proposed_station_admin = models.ForeignKey(
        User,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='station_admin_requests',
        verbose_name="Administrador de Estaci√≥n Propuesto"
    )

    request_status = models.CharField(
        max_length=10,
        choices=ValidationStatus.choices,
        default=ValidationStatus.PENDING,
        verbose_name="Estado de la Solicitud"
    )
    
    request_date = models.DateTimeField(auto_now_add=True, verbose_name="Fecha de Solicitud")
    review_date = models.DateTimeField(null=True, blank=True, verbose_name="Fecha de Revisi√≥n")
    review_comments = models.TextField(blank=True, verbose_name="Comentarios de Revisi√≥n")

    # Usuario que revis√≥ la solicitud, superadministrador
    reviewed_by = models.ForeignKey(
        User,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='reviewed_requests',
        verbose_name="Revisado por"
    )
    
    def __str__(self):
        return f"Solicitud de {self.institution.institute_name} - Estado: {self.get_request_status_display()}"
    
    class Meta:
        db_table = 'integration_request'
        verbose_name = "Solicitud de Integraci√≥n"
        verbose_name_plural = "Solicitudes de Integraci√≥n"
        ordering = ['-request_date']


================================================================================

        - serializers.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/institutions/serializers.py
--------------------------------------------------------------------------------
from rest_framework import serializers
from .models import EnvironmentalInstitution, InstitutionColorSet, IntegrationRequest
import json

class InstitutionColorSetSerializer(serializers.ModelSerializer):
    """
    Serializador auxiliar para la representaci√≥n anidada de colores.
    Dise√±ado principalmente para lectura (read-only) dentro de la instituci√≥n.
    """
    class Meta:
        model = InstitutionColorSet
        fields = ['id', 'color_hex']

class EnvironmentalInstitutionSerializer(serializers.ModelSerializer):
    """
    Serializador principal para Instituciones Ambientales.
    
    Maneja dos flujos de datos para los colores:
    1. 'colors': Salida anidada completa (read-only).
    2. 'colors_input': Entrada simplificada (lista de strings) para la creaci√≥n (write-only).
    """
    # Read-only para mostrar los datos
    colors = InstitutionColorSetSerializer(many=True, read_only=True)
    
    # Write-only para recibir la entrada simple
    colors_input = serializers.ListField(
        child=serializers.CharField(max_length=7), 
        write_only=True, 
        required=False
    )

    class Meta:
        model = EnvironmentalInstitution
        fields = [
            'id', 
            'institute_name', 
            'physic_address', 
            'institute_logo',
            'colors', 
            'colors_input',
            'created_at',
            'validation_status'
        ]
        read_only_fields = ['created_at', 'validation_status']

class IntegrationRequestSerializer(serializers.ModelSerializer):
    """
    Serializador para las solicitudes de integraci√≥n.
    Incluye el nombre de la instituci√≥n de forma plana para facilitar su lectura en frontend.
    """
    institution_name = serializers.CharField(source='institution.institute_name', read_only=True)

    class Meta:
        model = IntegrationRequest
        fields = '__all__'
        read_only_fields = ['request_date', 'reviewed_by', 'review_date']

class InstitutionRegistrationSerializer(serializers.ModelSerializer):
    """
    Serializador espec√≠fico para el registro inicial de una instituci√≥n.
    Maneja la recepci√≥n de colores como un string JSON (dado que viene de FormData).
    """
    # Se reciben los colores como un string JSON: '["#FFF", "#000"]'
    colors = serializers.CharField(write_only=True)

    class Meta:
        model = EnvironmentalInstitution
        fields = ['institute_name', 'physic_address', 'institute_logo', 'colors']

    def validate_colors(self, value):
        try:
            colors = json.loads(value)
            if not isinstance(colors, list):
                raise serializers.ValidationError("El formato debe ser una lista de colores.")
            return colors
        except ValueError:
            raise serializers.ValidationError("JSON de colores inv√°lido.")


================================================================================

        - services.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/institutions/services.py
--------------------------------------------------------------------------------
from .models import EnvironmentalInstitution, InstitutionColorSet, IntegrationRequest
from django.db import transaction
from django.core.exceptions import ValidationError
from django.shortcuts import get_object_or_404
from django.utils import timezone
from src.users.models import User

class InstitutionService:    
    """
    Capa de servicio para manejar la l√≥gica de negocio de las Instituciones.
    """
    @staticmethod
    def create_institution(data: dict, colors_list: list[str]) -> EnvironmentalInstitution:
        """
        Crea una instituci√≥n y asigna sus colores corporativos de forma at√≥mica.
        Args:
            data (dict): Diccionario con los datos del modelo EnvironmentalInstitution.
            colors_list (list[str]): Lista de c√≥digos hexadecimales de color.
        Returns:
            EnvironmentalInstitution: La instancia creada con sus relaciones.
        Raises:
            ValidationError: Si se supera el l√≠mite de colores permitidos (m√°x 5).
        """
        with transaction.atomic():
            # 1. Crear la entidad padre
            institution = EnvironmentalInstitution.objects.create(**data)
            # 2. Procesar y crear las entidades hijas (Colores)
            if colors_list:
                # Validamos reglas de negocio extra si fuera necesario (ej: m√°x 3 colores)
                if len(colors_list) > 5:
                    raise ValidationError("Una instituci√≥n no puede tener m√°s de 5 colores corporativos.")

                color_objects = [
                    InstitutionColorSet(institution=institution, color_hex=color)
                    for color in colors_list
                ]
                # Bulk create es m√°s eficiente para bases de datos grandes
                InstitutionColorSet.objects.bulk_create(color_objects)

            return institution

    @staticmethod
    def get_all_institutions():
        return EnvironmentalInstitution.objects.all().prefetch_related('colors')
    
    @staticmethod
    def register_institution(data: dict, colors: list, representative_user: User) -> EnvironmentalInstitution:
        """
        Registra una instituci√≥n, sus colores y asigna al usuario creador como representante
        dentro de una transacci√≥n at√≥mica.
        """
        unique_colors = list(set(colors))
        with transaction.atomic():
            institution = EnvironmentalInstitution.objects.create(**data)

            color_objects = [
                InstitutionColorSet(institution=institution, color_hex=color)
                for color in unique_colors 
            ]
            InstitutionColorSet.objects.bulk_create(color_objects)

            # Actualizamos el usuario representante para que pertenezca a esta instituci√≥n
            representative_user.institution = institution
            representative_user.save()
        
        return institution
    
    @staticmethod
    def approve_institution_service(institution_id: int):
        """
        Cambia el estado de validaci√≥n de una instituci√≥n a ACCEPTED.
        """
        institution = get_object_or_404(EnvironmentalInstitution, pk=institution_id)

        if institution.validation_status == 'ACCEPTED':
            # Opcional: Lanzar error o simplemente retornar sin cambios
            return institution

        institution.validation_status = 'ACCEPTED'
        institution.save()
        return institution

class IntegrationRequestService:
    """
    Capa de servicio para gestionar el flujo de aprobaci√≥n de solicitudes.
    """
    @staticmethod
    def create_request(data: dict) -> IntegrationRequest:
        """
        Registra una nueva solicitud de integraci√≥n validando duplicados.

        Evita que una misma instituci√≥n tenga m√∫ltiples solicitudes pendientes
        simult√°neamente (prevenci√≥n de spam).
        """
        existing_pending = IntegrationRequest.objects.filter(
            institution=data['institution'], 
            request_status=IntegrationRequest.RequestStatus.PENDING
        ).exists()
        
        if existing_pending:
            raise ValidationError("Esta instituci√≥n ya tiene una solicitud pendiente.")

        return IntegrationRequest.objects.create(**data)

    @staticmethod
    def approve_request(request_id: int, user) -> IntegrationRequest:
        """
        Aprueba una solicitud existente, registrando auditor√≠a del revisor.
        Args:
            request_id (int): ID de la solicitud.
            user (User): Usuario administrador que realiza la aprobaci√≥n.
        Returns:
            IntegrationRequest: La solicitud actualizada con estado APPROVED.
        """
        try:
            integration_request = IntegrationRequest.objects.get(pk=request_id)
        except IntegrationRequest.DoesNotExist:
            raise ValidationError(f"Solicitud {request_id} no encontrada.")

        with transaction.atomic():
            integration_request.request_status = IntegrationRequest.RequestStatus.APPROVED
            integration_request.reviewed_by = user
            integration_request.review_date = timezone.now()
            integration_request.save()
            
        return integration_request


================================================================================

        - tests.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/institutions/tests.py
--------------------------------------------------------------------------------
from django.test import TestCase
from django.core.exceptions import ValidationError
from src.institutions.services import InstitutionService, IntegrationRequestService
from src.institutions.models import EnvironmentalInstitution, InstitutionColorSet, IntegrationRequest

class InstitutionServiceTestCase(TestCase):
    def test_create_institution_with_colors(self):
        """
        Prueba crear instituci√≥n y sus colores en una sola transacci√≥n
        """
        data = {
            'institute_name': 'EcoLogic',
            'physic_address': 'Av Siempre Viva'
        }
        colors = ['#FF0000', '#00FF00']
        
        inst = InstitutionService.create_institution(data, colors)
        
        self.assertTrue(EnvironmentalInstitution.objects.filter(institute_name='EcoLogic').exists())
        self.assertEqual(inst.colors.count(), 2)

    def test_create_institution_excessive_colors(self):
        """
        Prueba la regla de negocio: M√°ximo 5 colores
        """
        data = {'institute_name': 'Rainbow', 'physic_address': 'Sky'}
        colors = ['#1', '#2', '#3', '#4', '#5', '#6'] # 6 colores
        
        with self.assertRaises(ValidationError):
            InstitutionService.create_institution(data, colors)
            
        # Verificar atomicidad: No se debi√≥ crear la instituci√≥n
        self.assertFalse(EnvironmentalInstitution.objects.filter(institute_name='Rainbow').exists())

class RequestServiceTestCase(TestCase):
    def setUp(self):
        self.inst = EnvironmentalInstitution.objects.create(institute_name="Test Inst", physic_address="x")

    def test_prevent_duplicate_pending_requests(self):
        """
        Evitar spam de solicitudes
        """
        # Crear primera solicitud
        IntegrationRequestService.create_request({'institution': self.inst})
        
        # Intentar crear segunda solicitud pendiente
        with self.assertRaises(ValidationError):
            IntegrationRequestService.create_request({'institution': self.inst})

================================================================================

        - urls.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/institutions/urls.py
--------------------------------------------------------------------------------
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import ApproveInstitutionView, InstitutionViewSet, IntegrationRequestViewSet, RegisterInstitutionView

router = DefaultRouter()
router.register(r'institutes', InstitutionViewSet, basename='institute')
router.register(r'requests', IntegrationRequestViewSet, basename='integration-request')

urlpatterns = [
    path('register/', RegisterInstitutionView.as_view(), name='register-institution'),
    path('requests/<int:pk>/approve/', ApproveInstitutionView.as_view(), name='approve-institution'),
    path('', include(router.urls)),
]

================================================================================

        - views.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/institutions/views.py
--------------------------------------------------------------------------------
from rest_framework import viewsets, permissions, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.parsers import MultiPartParser, FormParser
from rest_framework.views import APIView
from django.core.exceptions import ValidationError as DjangoValidationError
from .models import EnvironmentalInstitution, IntegrationRequest
from .serializers import EnvironmentalInstitutionSerializer, InstitutionRegistrationSerializer, IntegrationRequestSerializer
from .services import InstitutionService, IntegrationRequestService

class InstitutionViewSet(viewsets.ModelViewSet):
    """
    ViewSet para la gesti√≥n de Instituciones Ambientales.
    Rutas principales:
    - GET /api/institutions/institutes/: Lista todas las instituciones.
    - POST /api/institutions/institutes/: Crea una instituci√≥n y sus colores (Transaccional).
    """
    queryset = EnvironmentalInstitution.objects.all()
    serializer_class = EnvironmentalInstitutionSerializer
    permission_classes = [permissions.IsAuthenticated]

    def create(self, request, *args, **kwargs):
        """
        Sobrescribe el m√©todo create para delegar la l√≥gica compleja al InstitutionService.
        Separa los datos del modelo principal de la lista de colores input.
        """
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        # Separamos los datos del modelo principal y los datos extra (colores)
        validated_data = serializer.validated_data
        colors_data = validated_data.pop('colors_input', [])

        try:
            # LLAMADA AL SERVICIO
            institution = InstitutionService.create_institution(
                data=validated_data, 
                colors_list=colors_data
            )
            
            # Serializamos el resultado final (que ahora incluye los colores creados)
            output_serializer = self.get_serializer(institution)
            return Response(output_serializer.data, status=status.HTTP_201_CREATED)

        except DjangoValidationError as e:
            return Response({"detail": e.messages}, status=status.HTTP_400_BAD_REQUEST)
        except Exception as e:
            return Response({"detail": str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)

class IntegrationRequestViewSet(viewsets.ModelViewSet):
    """
    ViewSet para la gesti√≥n de Solicitudes de Integraci√≥n.
    Incluye endpoints est√°ndar CRUD y acciones personalizadas para flujos de aprobaci√≥n.
    """
    queryset = IntegrationRequest.objects.all()
    serializer_class = IntegrationRequestSerializer
    permission_classes = [permissions.IsAuthenticated]

    def create(self, request, *args, **kwargs):
        """
        Crea una solicitud utilizando el servicio para validar reglas de negocio (duplicidad).
        """
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        try:
            # LLAMADA AL SERVICIO DE CREACI√ìN
            req_instance = IntegrationRequestService.create_request(serializer.validated_data)
            output_serializer = self.get_serializer(req_instance)
            return Response(output_serializer.data, status=status.HTTP_201_CREATED)
            
        except DjangoValidationError as e:
             return Response({"detail": e.messages}, status=status.HTTP_400_BAD_REQUEST)

    @action(detail=True, methods=['post'], permission_classes=[permissions.IsAdminUser])
    def approve(self, request, pk=None):
        """
        Acci√≥n personalizada para aprobar una solicitud.
        Endpoint: POST /api/institutions/requests/{id}/approve/
        Solo accesible por administradores. Asigna fecha de revisi√≥n y revisor autom√°ticamente.
        """
        try:
            # LLAMADA AL SERVICIO DE APROBACI√ìN
            IntegrationRequestService.approve_request(pk, request.user)
            return Response({'status': 'Solicitud aprobada correctamente'})
            
        except DjangoValidationError as e:
             return Response({"detail": e.messages}, status=status.HTTP_404_NOT_FOUND)
        except Exception as e:
            return Response({"detail": str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)

class RegisterInstitutionView(APIView):
    """
    Endpoint para que un representante registre su instituci√≥n.
    Soporta multipart/form-data para subir el logo.
    """
    permission_classes = [permissions.IsAuthenticated]
    parser_classes = (MultiPartParser, FormParser) # Crucial para subir im√°genes

    def post(self, request):
        serializer = InstitutionRegistrationSerializer(data=request.data)
        
        if serializer.is_valid():
            validated_data = serializer.validated_data
            colors = validated_data.pop('colors')
            
            try:
                # Llamada al servicio at√≥mico
                institution = InstitutionService.register_institution(
                    data=validated_data,
                    colors=colors,
                    representative_user=request.user
                )
                
                # Devolvemos la instituci√≥n creada usando el serializador de lectura est√°ndar
                return Response(
                    EnvironmentalInstitutionSerializer(institution).data, 
                    status=status.HTTP_201_CREATED
                )
            except Exception as e:
                return Response(
                    {"detail": str(e)}, 
                    status=status.HTTP_500_INTERNAL_SERVER_ERROR
                )
        
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

class ApproveInstitutionView(APIView):
    """
    Endpoint dedicado para aprobar una instituci√≥n.
    Ruta: POST /api/institutions/requests/<int:pk>/approve/
    """
    permission_classes = [permissions.IsAdminUser]

    def post(self, request, pk):
        try:
            institution = InstitutionService.approve_institution_service(pk)
            # Retornamos la data actualizada
            serializer = EnvironmentalInstitutionSerializer(institution)
            return Response(serializer.data, status=status.HTTP_200_OK)
        except Exception as e:
            return Response(
                {"detail": "Error aprobando la instituci√≥n", "error": str(e)}, 
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

================================================================================

    [measurements/]
        - __init__.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/measurements/__init__.py
--------------------------------------------------------------------------------


================================================================================

        - admin.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/measurements/admin.py
--------------------------------------------------------------------------------
from django.contrib import admin

# Register your models here.


================================================================================

        - apps.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/measurements/apps.py
--------------------------------------------------------------------------------
from django.apps import AppConfig


class MeasurementsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'src.measurements'


================================================================================

        - models.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/measurements/models.py
--------------------------------------------------------------------------------
from django.db import models

from django.db import models
from src.sensors.models import Sensor 

class VariableCatalog(models.Model):
    """
    Cat√°logo maestro de variables meteorol√≥gicas y contaminantes.
    Act√∫a como un diccionario para definir qu√© tipos de datos puede interpretar el sistema.
    Define metadatos como unidades de medida y rangos de validaci√≥n autom√°tica.
    """
    variable_id = models.AutoField(primary_key=True)
    name = models.CharField(max_length=100, verbose_name="Nombre (Ej: Material Particulado 2.5)")
    code = models.CharField(max_length=20, unique=True, verbose_name="C√≥digo (Ej: PM2.5)")
    unit = models.CharField(max_length=20, verbose_name="Unidad (Ej: ¬µg/m¬≥)")
    
    # L√≠mites para validaci√≥n b√°sica de calidad de datos
    min_expected_value = models.FloatField(default=0)
    max_expected_value = models.FloatField(default=1000)

    def __str__(self):
        return f"{self.name} ({self.unit})"

    class Meta:
        db_table = 'variable_catalog'  
        verbose_name = "Cat√°logo de Variables"
        verbose_name_plural = "Cat√°logos de Variables"

class Measurement(models.Model):
    """
    Registro hist√≥rico de una medici√≥n individual.
    Esta tabla almacena la serie de tiempo de los datos recolectados.
    Est√° optimizada para b√∫squedas por sensor y fecha.
    """
    measurement_id = models.AutoField(primary_key=True)
    
    # Relaci√≥n con el Sensor (Core del requerimiento)
    sensor = models.ForeignKey(
        Sensor,
        on_delete=models.CASCADE,
        related_name='measurements',
        verbose_name="Sensor Origen"
    )
    
    # Relaci√≥n con la Variable
    variable = models.ForeignKey(
        VariableCatalog,
        on_delete=models.PROTECT,
        related_name='measurements'
    )
    
    value = models.FloatField(verbose_name="Valor Medido")
    measure_date = models.DateTimeField(verbose_name="Fecha de Toma de Dato")
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"{self.variable.code}: {self.value}"
    
    class Meta:
        db_table = 'measurement'  # Nombre limpio en DBeaver
        verbose_name = "Medici√≥n"
        verbose_name_plural = "Mediciones"
        ordering = ['-measure_date']
        indexes = [
            models.Index(fields=['sensor', 'measure_date']),
        ]

================================================================================

        - serializers.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/measurements/serializers.py
--------------------------------------------------------------------------------
from rest_framework import serializers
from .models import VariableCatalog, Measurement

class VariableCatalogSerializer(serializers.ModelSerializer):
    """
    Serializador para el cat√°logo de variables.
    Permite ver y definir los tipos de datos del sistema.
    """
    class Meta:
        model = VariableCatalog
        fields = '__all__'

class MeasurementSerializer(serializers.ModelSerializer):
    """
    Serializador para los registros de mediciones.
    Comportamiento:
    - Escritura (Write): Recibe IDs de 'sensor' y 'variable'.
    - Lectura (Read): Incluye campos 'aplanados' (sensor_serial, variable_code)
      para facilitar el consumo en el Frontend sin hacer peticiones extra.
    """
    sensor_serial = serializers.CharField(source='sensor.serial_number', read_only=True)
    variable_code = serializers.CharField(source='variable.code', read_only=True)
    variable_unit = serializers.CharField(source='variable.unit', read_only=True)

    class Meta:
        model = Measurement
        fields = [
            'measurement_id', 
            'sensor', 
            'sensor_serial', 
            'variable', 
            'variable_code', 
            'variable_unit',
            'value', 
            'measure_date', 
            'created_at'
        ]

================================================================================

        - services.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/measurements/services.py
--------------------------------------------------------------------------------
from django.db import transaction
from django.core.exceptions import ValidationError
from .models import Measurement
from src.sensors.models import Sensor

class MeasurementService:
    """
    Capa de servicio para la gesti√≥n de mediciones.
    Centraliza la l√≥gica de negocio, validaciones de integridad y control de calidad
    de datos antes de persistir en la base de datos.
    """
    @staticmethod
    def create_measurement(data: dict) -> Measurement:
        """
        Crea un registro de medici√≥n validando reglas estrictas de negocio.
        Flujo de Validaci√≥n:
        1. Verifica que el Sensor exista y est√© en estado 'ACTIVE'.
        2. Verifica que el valor medido est√© dentro de los rangos f√≠sicos posibles
           definidos en el cat√°logo de variables (Control de Calidad).
        Args:
            data (dict): Diccionario con datos validados (sensor, variable, value, date).                 Generalmente proviene de serializer.validated_data.
        Returns:
            Measurement: La instancia del modelo creada y guardada.
        Raises:
            - Si el sensor est√° INACTIVO o en MANTENIMIENTO.
            - Si el valor (value) est√° fuera de los rangos min/max esperados.
        """
        sensor = data.get('sensor')
        variable = data.get('variable')
        value = data.get('value')

        # 1. Validaci√≥n de Negocio: Sensor Activo
        if sensor.status != Sensor.Status.ACTIVE:
            raise ValidationError(f"El sensor {sensor.serial_number} no est√° activo (Estado: {sensor.status}).")

        # 2. Validaci√≥n de Negocio: Rango de valores (Calidad de datos simple)
        if value < variable.min_expected_value or value > variable.max_expected_value:
            raise ValidationError(f"El valor {value} est√° fuera del rango permitido para {variable.code}.")

        with transaction.atomic():
            measurement = Measurement.objects.create(**data)
            return measurement

================================================================================

        - tests.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/measurements/tests.py
--------------------------------------------------------------------------------
from django.test import TestCase
from django.utils import timezone
from django.core.exceptions import ValidationError
from src.measurements.services import MeasurementService
from src.measurements.models import VariableCatalog
from src.sensors.models import Sensor
from src.stations.models import MonitoringStation 
from src.institutions.models import EnvironmentalInstitution

class MeasurementServiceTestCase(TestCase):
    def setUp(self):
        # Configurar jerarqu√≠a
        self.inst = EnvironmentalInstitution.objects.create(institute_name="Data Inst", physic_address="x")
        self.station = MonitoringStation.objects.create(
            station_name="Est1", 
            institution=self.inst, 
            geographic_location_lat=0, 
            geographic_location_long=0
        )
        
        # Sensor Activo
        self.sensor = Sensor.objects.create(
            serial_number="SN-123", 
            model="X1", 
            manufacturer="Acme", 
            installation_date="2023-01-01",
            status=Sensor.Status.ACTIVE,
            # station=self.station # Descomentar cuando arregles el modelo Sensor
        )
        
        # Variable: Temp (0 a 50 grados)
        self.variable = VariableCatalog.objects.create(
            name="Temperatura", code="TEMP", unit="C",
            min_expected_value=0, max_expected_value=50
        )

    def test_create_valid_measurement(self):
        """
        Flujo correcto: Crear medici√≥n v√°lida
        """
        data = {
            'sensor': self.sensor,
            'variable': self.variable,
            'value': 25.5,
            'measure_date': timezone.now()
        }
        measurement = MeasurementService.create_measurement(data)
        self.assertEqual(measurement.value, 25.5)

    def test_reject_inactive_sensor(self):
        """
        Falla si el sensor est√° en mantenimiento o inactivo
        """
        self.sensor.status = Sensor.Status.MAINTENANCE
        self.sensor.save()
        
        data = {
            'sensor': self.sensor,
            'variable': self.variable,
            'value': 25.5,
            'measure_date': timezone.now()
        }
        with self.assertRaises(ValidationError) as cm:
            MeasurementService.create_measurement(data)
        self.assertIn("no est√° activo", str(cm.exception))

    def test_reject_out_of_range_value(self):
        """
        Falla si el valor es f√≠sicamente imposible (definido en cat√°logo)
        """
        data = {
            'sensor': self.sensor,
            'variable': self.variable,
            'value': 150.0, # Max es 50
            'measure_date': timezone.now()
        }
        with self.assertRaises(ValidationError) as cm:
            MeasurementService.create_measurement(data)
        self.assertIn("fuera del rango permitido", str(cm.exception))


================================================================================

        - urls.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/measurements/urls.py
--------------------------------------------------------------------------------
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import MeasurementViewSet, VariableCatalogViewSet

router = DefaultRouter()
router.register(r'variables', VariableCatalogViewSet, basename='variables')
router.register(r'data', MeasurementViewSet, basename='measurements')

urlpatterns = [
    path('', include(router.urls)),
] 

================================================================================

        - views.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/measurements/views.py
--------------------------------------------------------------------------------
from django.shortcuts import render

from rest_framework import viewsets, permissions, status
from rest_framework.response import Response
from django.core.exceptions import ValidationError as DjangoValidationError
from .models import Measurement, VariableCatalog
from .serializers import MeasurementSerializer, VariableCatalogSerializer
from .services import MeasurementService

class VariableCatalogViewSet(viewsets.ModelViewSet):
    """
    Endpoint: /api/measurements/variables/
    Gesti√≥n del cat√°logo de variables.
    Permite listar, crear y editar los tipos de contaminantes o variables clim√°ticas.
    Permisos:
        - Requiere autenticaci√≥n.
        - (TODO: Idealmente solo Administradores deber√≠an poder crear/editar/borrar).
    """
    queryset = VariableCatalog.objects.all()
    serializer_class = VariableCatalogSerializer
    permission_classes = [permissions.IsAuthenticated]

class MeasurementViewSet(viewsets.ModelViewSet):
    """
    Endpoint: /api/measurements/data/
    Gesti√≥n de los datos recolectados (Mediciones).
    Permite la ingesta de datos y la consulta hist√≥rica.
    """
    queryset = Measurement.objects.all()
    serializer_class = MeasurementSerializer
    permission_classes = [permissions.IsAuthenticated]

    def create(self, request, *args, **kwargs):
        """
        Sobrescribe el m√©todo POST para delegar la l√≥gica al Service Layer.
        Maneja la traducci√≥n de excepciones de negocio (ValidationError) 
        a respuestas HTTP estandarizadas (400 Bad Request).
        """
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        try:
            # La creaci√≥n al servicio para validar reglas, es delegada a services.py.
            measurement = MeasurementService.create_measurement(serializer.validated_data)
            output_serializer = self.get_serializer(measurement)
            return Response(output_serializer.data, status=status.HTTP_201_CREATED)
            
        except DjangoValidationError as e:
            return Response({"detail": e.messages}, status=status.HTTP_400_BAD_REQUEST)
        except Exception as e:
            return Response({"detail": str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)


================================================================================

    [sensors/]
        - __init__.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/sensors/__init__.py
--------------------------------------------------------------------------------


================================================================================

        - admin.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/sensors/admin.py
--------------------------------------------------------------------------------
from django.contrib import admin

# Register your models here.


================================================================================

        - apps.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/sensors/apps.py
--------------------------------------------------------------------------------
from django.apps import AppConfig


class SensorsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'src.sensors'


================================================================================

        - models.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/sensors/models.py
--------------------------------------------------------------------------------
from django.db import models
from src.stations.models import MonitoringStation

class Sensor(models.Model):
    """
    Representa un dispositivo sensor f√≠sico dentro del sistema.
    Almacena informaci√≥n t√©cnica como modelo, fabricante, n√∫mero de serie
    y el estado operativo actual del dispositivo.
    """
    sensor_id = models.AutoField(primary_key=True)
    model = models.CharField(max_length=100, verbose_name="Modelo del Sensor")
    manufacturer = models.CharField(max_length=100, verbose_name="Fabricante")
    serial_number = models.CharField(max_length=100, unique=True, verbose_name="N√∫mero de Serie")
    installation_date = models.DateField(verbose_name="Fecha de Instalaci√≥n")
    
    station = models.ForeignKey(
        MonitoringStation,
        on_delete=models.CASCADE,
        related_name='sensors',
        verbose_name="Estaci√≥n Asignada",
        null=True, blank=True 
    ) 



    class Status(models.TextChoices):
        ACTIVE = 'ACTIVE', 'Activo'
        INACTIVE = 'INACTIVE', 'Inactivo'
        MAINTENANCE = 'MAINTENANCE', 'Mantenimiento'

    status = models.CharField(
        max_length=20, 
        choices=Status.choices, 
        default=Status.ACTIVE,
        verbose_name="Estado"
    )

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.model} - {self.serial_number} ({self.status})"
    
    class Meta:
        db_table = 'sensor' 
        verbose_name = "Sensor"
        verbose_name_plural = "Sensores"


================================================================================

        - serializers.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/sensors/serializers.py
--------------------------------------------------------------------------------
from rest_framework import serializers
from .models import Sensor

class SensorSerializer(serializers.ModelSerializer):
    """
    Serializador est√°ndar para el modelo Sensor.
    Los campos de auditor√≠a (fechas) son de solo lectura.
    """
    class Meta:
        model = Sensor
        fields = '__all__'
        read_only_fields = ['created_at', 'updated_at']

================================================================================

        - services.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/sensors/services.py
--------------------------------------------------------------------------------
from django.db import transaction
from django.core.exceptions import ValidationError
from .models import Sensor

class SensorService:
    """
    Capa de servicio para encapsular la l√≥gica de negocio de los Sensores.
    """
    @staticmethod
    def create_sensor(data: dict) -> Sensor:
        """
        Crea un nuevo sensor en la base de datos de forma transaccional.
        Args:
            data (dict): Datos validados del sensor. 
        Returns:
            Sensor: Instancia del sensor creado.
        """
        with transaction.atomic():
            sensor = Sensor.objects.create(**data)
            return sensor

    @staticmethod
    def update_sensor_status(sensor_id: int, new_status: str) -> Sensor:
        """
        Actualiza el estado operativo de un sensor espec√≠fico.
        Args:
            sensor_id (int): Identificador √∫nico del sensor.
            new_status (str): Nuevo estado (debe coincidir con Sensor.Status).
        Raises:
            ValidationError: Si el sensor no existe.
        """
        try:
            sensor = Sensor.objects.get(pk=sensor_id)
            sensor.status = new_status
            sensor.save()
            return sensor
        except Sensor.DoesNotExist:
            raise ValidationError(f"El sensor {sensor_id} no existe.")

================================================================================

        - tests.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/sensors/tests.py
--------------------------------------------------------------------------------
from django.test import TestCase
from django.core.exceptions import ValidationError
from src.sensors.services import SensorService
from src.sensors.models import Sensor
from src.stations.models import MonitoringStation
from src.institutions.models import EnvironmentalInstitution
from django.utils import timezone

class SensorServiceTestCase(TestCase):
    def setUp(self):
        """
        Configuraci√≥n inicial: Creamos la jerarqu√≠a necesaria (Instituci√≥n -> Estaci√≥n)
        para poder asignarle un sensor a una estaci√≥n.
        """
        self.institution = EnvironmentalInstitution.objects.create(
            institute_name="Tech Vrisa",
            physic_address="Calle 100"
        )
        self.station = MonitoringStation.objects.create(
            station_name="Estaci√≥n Central",
            geographic_location_lat=4.6,
            geographic_location_long=-74.0,
            institution=self.institution
        )

    def test_create_sensor_success(self):
        """
        Prueba que el servicio crea un sensor correctamente y lo vincula a la estaci√≥n.
        """
        data = {
            'model': 'AirSense Pro',
            'manufacturer': 'VrisaLabs',
            'serial_number': 'SN-001',
            'installation_date': timezone.now().date(),
            'status': Sensor.Status.ACTIVE,
            'station': self.station  # Aqu√≠ probamos la relaci√≥n cr√≠tica
        }

        sensor = SensorService.create_sensor(data)

        # Verificaciones
        self.assertEqual(sensor.serial_number, 'SN-001')
        self.assertEqual(sensor.station, self.station)
        self.assertEqual(sensor.status, Sensor.Status.ACTIVE)
        # Verificar que se guard√≥ en la DB
        self.assertTrue(Sensor.objects.filter(serial_number='SN-001').exists())

    def test_update_sensor_status_success(self):
        """
        Prueba que se puede actualizar el estado operativo de un sensor.
        """
        # 1. Crear sensor inicial
        sensor = Sensor.objects.create(
            model='Basic',
            manufacturer='Test',
            serial_number='SN-UPDATE',
            installation_date=timezone.now().date(),
            status=Sensor.Status.ACTIVE,
            station=self.station
        )

        # 2. Llamar al servicio para cambiar estado a MANTENIMIENTO
        updated_sensor = SensorService.update_sensor_status(sensor.sensor_id, Sensor.Status.MAINTENANCE)

        # 3. Verificar cambio en memoria y en DB
        self.assertEqual(updated_sensor.status, Sensor.Status.MAINTENANCE)
        sensor.refresh_from_db() # Recargar desde la base de datos
        self.assertEqual(sensor.status, Sensor.Status.MAINTENANCE)

    def test_update_sensor_not_found(self):
        """
        Prueba que el servicio lanza ValidationError si el ID del sensor no existe.
        """
        non_existent_id = 99999
        
        with self.assertRaises(ValidationError) as context:
            SensorService.update_sensor_status(non_existent_id, Sensor.Status.INACTIVE)
        
        self.assertIn(f"El sensor {non_existent_id} no existe", str(context.exception))

================================================================================

        - urls.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/sensors/urls.py
--------------------------------------------------------------------------------
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import SensorViewSet

router = DefaultRouter()
router.register(r'', SensorViewSet, basename='sensor')

urlpatterns = [
    path('', include(router.urls)),
]

================================================================================

        - views.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/sensors/views.py
--------------------------------------------------------------------------------
from django.shortcuts import render

from rest_framework import viewsets, permissions, status
from rest_framework.response import Response
from django.core.exceptions import ValidationError as DjangoValidationError
from .models import Sensor
from .serializers import SensorSerializer
from .services import SensorService

class SensorViewSet(viewsets.ModelViewSet):
    """
    ViewSet para operaciones CRUD sobre los sensores.
    Delega la creaci√≥n al SensorService para mantener la consistencia
    y permitir futuras expansiones de l√≥gica de negocio.
    """
    queryset = Sensor.objects.all()
    serializer_class = SensorSerializer
    permission_classes = [permissions.IsAuthenticated]

    def create(self, request, *args, **kwargs):
        """
        Intercepta la creaci√≥n para utilizar el SensorService.
        """
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        try:
            # Llamada al servicio
            sensor = SensorService.create_sensor(serializer.validated_data)
            output_serializer = self.get_serializer(sensor)
            return Response(output_serializer.data, status=status.HTTP_201_CREATED)
        except DjangoValidationError as e:
            return Response({"detail": e.messages}, status=status.HTTP_400_BAD_REQUEST)
        except Exception as e:
            return Response({"detail": str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)

================================================================================

    [stations/]
        - __init__.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/stations/__init__.py
--------------------------------------------------------------------------------


================================================================================

        - admin.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/stations/admin.py
--------------------------------------------------------------------------------
from django.contrib import admin
from src.stations.models import MonitoringStation

@admin.register(MonitoringStation)
class MonitoringStationAdmin(admin.ModelAdmin):
    """
    Configuraci√≥n del panel de administraci√≥n para el modelo MonitoringStation.
    """
    list_display = (
        'station_name', 
        'operative_status', 
        'institution', 
        'geographic_location_lat', 
        'geographic_location_long'
    )
    list_filter = ('operative_status', 'institution')
    search_fields = ('station_name', 'institution__institute_name')
    
    # El token debe ser solo visible
    readonly_fields = ('authentication_token', 'created_at', 'updated_at')
    
    fieldsets = (
        (None, {'fields': ('station_name', 'institution', 'manager_user')}),
        ('Ubicaci√≥n y Estado', {'fields': ('geographic_location_lat', 'geographic_location_long', 'operative_status')}),
        ('Credenciales', {'fields': ('authentication_token',)}),
        ('Auditor√≠a', {'fields': ('created_at', 'updated_at')}),
    )

================================================================================

        - apps.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/stations/apps.py
--------------------------------------------------------------------------------
from django.apps import AppConfig


class StationsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'src.stations'
    label = 'stations'


================================================================================

        - models.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/stations/models.py
--------------------------------------------------------------------------------
from django.db import models
from django.conf import settings
from src.institutions.models import EnvironmentalInstitution
import secrets

# Referencia al modelo de usuario (User)
User = settings.AUTH_USER_MODEL

class MonitoringStation(models.Model):
    """
    Representa una estaci√≥n de monitoreo en la red (tabla 'monitoring_station').
    
    Esta entidad es el n√∫cleo de la recolecci√≥n de datos. Almacena la ubicaci√≥n f√≠sica,
    el estado operativo y las credenciales de autenticaci√≥n para los sensores IoT.
    """
    station_id = models.AutoField(primary_key=True)
    
    station_name = models.CharField(
        max_length=150, 
        unique=True,
        verbose_name="Nombre de la Estaci√≥n"
    )
    
    # Estados operativos definidos como Enumeraci√≥n
    class OperativeStatus(models.TextChoices):
        ACTIVE = 'ACTIVE', 'Operativa'
        MAINTENANCE = 'MAINTENANCE', 'En Mantenimiento'
        INACTIVE = 'INACTIVE', 'Inactiva'
        OFFLINE = 'OFFLINE', 'Fuera de L√≠nea'

    operative_status = models.CharField(
        max_length=20,
        choices=OperativeStatus.choices,
        default=OperativeStatus.INACTIVE,
        verbose_name="Estado Operativo"
    )

    # Token de seguridad para que la estaci√≥n env√≠e datos a la API.
    # Se genera autom√°ticamente en el servicio si no se provee.
    authentication_token = models.CharField(
        max_length=255, 
        unique=True,
        editable=False, # No se debe editar manualmente en el admin por seguridad
        verbose_name="Token de Autenticaci√≥n"
    )

    # Coordenadas geogr√°ficas (seg√∫n diagrama: FLOAT)
    geographic_location_lat = models.FloatField(verbose_name="Latitud")
    geographic_location_long = models.FloatField(verbose_name="Longitud")

    # Auditor√≠a
    created_at = models.DateTimeField(auto_now_add=True, verbose_name="Fecha de creaci√≥n")
    updated_at = models.DateTimeField(auto_now=True, verbose_name="Fecha de actualizaci√≥n")

    # Relaciones (Foreign Keys)
    manager_user = models.ForeignKey(
        User,
        on_delete=models.SET_NULL, # Si se borra el usuario, la estaci√≥n queda sin manager (no se borra)
        null=True,
        blank=True,
        related_name='managed_stations',
        verbose_name="Responsable T√©cnico (Manager)"
    )

    institution = models.ForeignKey(
        EnvironmentalInstitution,
        on_delete=models.CASCADE, # Si se borra la instituci√≥n, se borran sus estaciones
        related_name='stations',
        verbose_name="Instituci√≥n Propietaria"
    )

    def __str__(self):
        return f"{self.station_name} ({self.get_operative_status_display()})"

    def save(self, *args, **kwargs):
        """
        Sobreescritura del m√©todo save para asegurar que siempre exista un token.
        """
        if not self.authentication_token:
            # Genera un token seguro de 32 bytes (64 caracteres hex)
            self.authentication_token = secrets.token_hex(32)
        super().save(*args, **kwargs)

    class Meta:
        db_table = 'monitoring_station'
        verbose_name = "Estaci√≥n de Monitoreo"
        verbose_name_plural = "Estaciones de Monitoreo"

================================================================================

        - serializer.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/stations/serializer.py
--------------------------------------------------------------------------------
from rest_framework import serializers
from src.stations.models import MonitoringStation
from src.institutions.models import EnvironmentalInstitution
from src.users.serializers import UserSerializer

class MonitoringStationSerializer(serializers.ModelSerializer):
    """
    Serializador de SALIDA completo para la estaci√≥n.
    """
    # Incluimos detalles del manager para no mostrar solo el ID
    manager_user = UserSerializer(read_only=True)
    institution_name = serializers.CharField(source='institution.institute_name', read_only=True)

    class Meta:
        model = MonitoringStation
        fields = [
            'station_id', 'station_name', 'operative_status',
            'geographic_location_lat', 'geographic_location_long',
            'created_at', 'updated_at', 'manager_user', 'institution_id', 'institution_name'
        ]

class CreateStationSerializer(serializers.Serializer):
    """
    Serializador de ENTRADA para crear estaciones.
    """
    station_name = serializers.CharField(max_length=150)
    geographic_location_lat = serializers.FloatField()
    geographic_location_long = serializers.FloatField()
    institution_id = serializers.IntegerField()
    manager_user_id = serializers.IntegerField(required=False)

    def validate_geographic_location_lat(self, value):
        if value < -90 or value > 90:
            raise serializers.ValidationError("La latitud debe estar entre -90 y 90 grados.")
        return value

    def validate_geographic_location_long(self, value):
        if value < -180 or value > 180:
            raise serializers.ValidationError("La longitud debe estar entre -180 y 180 grados.")
        return value

    def validate_institution_id(self, value):
        if not EnvironmentalInstitution.objects.filter(pk=value).exists():
            raise serializers.ValidationError("La instituci√≥n no existe.")
        return value

================================================================================

        - services.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/stations/services.py
--------------------------------------------------------------------------------
from django.db import transaction
from django.shortcuts import get_object_or_404
from src.stations.models import MonitoringStation
from src.institutions.models import EnvironmentalInstitution
from src.users.models import User
import secrets

def create_station(validated_data: dict, user_id: int) -> MonitoringStation:
    """
    Crea una nueva estaci√≥n de monitoreo en el sistema.
    
    Reglas de negocio:
    1. Verifica que la instituci√≥n exista.
    2. Asigna autom√°ticamente un token de autenticaci√≥n seguro.
    3. Asigna al usuario creador como manager inicial (si aplica) o valida el manager enviado.
    
    Args:
        validated_data (dict): Datos validados del serializer.
        user_id (int): ID del usuario que realiza la acci√≥n (para auditor√≠a o asignaci√≥n).
        
    Returns:
        MonitoringStation: La instancia creada.
    """
    
    # Extraer datos b√°sicos
    name = validated_data.get('station_name')
    lat = validated_data.get('geographic_location_lat')
    lon = validated_data.get('geographic_location_long')
    institution_id = validated_data.get('institution_id')
    
    # Verificar Instituci√≥n
    institution = get_object_or_404(EnvironmentalInstitution, pk=institution_id)
    
    # Verificar Manager (si viene en los datos, usamos ese, si no, el usuario actual)
    manager_id = validated_data.get('manager_user_id', user_id)
    manager = get_object_or_404(User, pk=manager_id)

    with transaction.atomic():
        # Crear la estaci√≥n
        # Nota: El m√©todo .save() del modelo se encargar√° de generar el token si falta
        station = MonitoringStation.objects.create(
            station_name=name,
            geographic_location_lat=lat,
            geographic_location_long=lon,
            institution=institution,
            manager_user=manager,
            operative_status=MonitoringStation.OperativeStatus.INACTIVE # Nace inactiva por defecto
        )
        
    return station

def regenerate_station_token(station_id: int) -> str:
    """
    Regenera el token de autenticaci√≥n de una estaci√≥n por seguridad.
    √ötil si se sospecha que las credenciales de la estaci√≥n fueron comprometidas.
    """
    station = get_object_or_404(MonitoringStation, pk=station_id)
    new_token = secrets.token_hex(32)
    
    station.authentication_token = new_token
    station.save()
    
    return new_token

================================================================================

        - tests.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/stations/tests.py
--------------------------------------------------------------------------------
from django.test import TestCase
from src.stations.services import create_station
from src.institutions.models import EnvironmentalInstitution
from src.users.models import User

class StationServiceTestCase(TestCase):
    def setUp(self):
        self.user = User.objects.create(email="admin@st.com", first_name="A", last_name="B")
        self.inst = EnvironmentalInstitution.objects.create(institute_name="StationOwner", physic_address="x")

    def test_station_auto_token_generation(self):
        """
        Prueba que el servicio genera un token si no se env√≠a
        """
        data = {
            'station_name': 'Alpha Station',
            'geographic_location_lat': 10.5,
            'geographic_location_long': -75.5,
            'institution_id': self.inst.id,
            # No enviamos token
        }
        
        station = create_station(data, self.user.id)
        
        self.assertIsNotNone(station.authentication_token)
        self.assertEqual(len(station.authentication_token), 64) # 32 bytes hex
        self.assertEqual(station.manager_user, self.user)

================================================================================

        - views.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/stations/views.py
--------------------------------------------------------------------------------
from django.shortcuts import render

# Create your views here.


================================================================================

    [users/]
        - __init__.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/users/__init__.py
--------------------------------------------------------------------------------


================================================================================

        - admin.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/users/admin.py
--------------------------------------------------------------------------------
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin as BaseUserAdmin
from src.users.models import User, Role, UserRole

class UserRoleInline(admin.TabularInline):
    """
    Permite la edici√≥n en l√≠nea de los roles asignados a un usuario 
    directamente desde la vista de detalle del Usuario en el Admin.
    
    Esto visualiza la tabla 'user_role'.
    """
    model = UserRole
    extra = 1
    autocomplete_fields = ['role']

@admin.register(User)
class UserAdmin(BaseUserAdmin):
    """
    Configuraci√≥n del panel de administraci√≥n para el modelo User.
    Organiza los campos en grupos l√≥gicos y muestra las relaciones nuevas.
    """
    # Campos a mostrar en la lista de registros
    list_display = ('email', 'first_name', 'last_name', 'institution', 'is_staff')    
    # Filtros laterales
    list_filter = ('institution', 'is_active')

    fieldsets = (
        (None, {'fields': ('email', 'password')}),
        ('Informaci√≥n Personal', {
            'fields': ('first_name', 'last_name', 'job_title', 'institution')
        }),
        ('Documentaci√≥n Profesional', {
            'fields': ('professional_card_front', 'professional_card_rear')
        }),
        ('Permisos', {
            'fields': ('is_active', 'is_staff', 'is_superuser', 'groups', 'user_permissions')
        }),
        ('Auditor√≠a', {
            'fields': ('last_login', 'date_joined', 'created_at', 'updated_at')
        })
    )
    readonly_fields = ('created_at', 'updated_at', 'last_login', 'date_joined')
    
    # Campos para el formulario de creaci√≥n
    add_fieldsets = (
        (None, {
            'classes': ('wide',),
            'fields': ('email', 'password', 'password2', 'first_name', 'last_name', 'institution'),
        }),
    )
    
    search_fields = ('email', 'first_name', 'last_name', 'institution__institute_name')
    ordering = ('email',)

@admin.register(Role)
class RoleAdmin(admin.ModelAdmin):
    """
    Administraci√≥n de los roles del sistema.
    """
    list_display = ('role_id', 'role_name', 'created_at')
    search_fields = ('role_name',)

@admin.register(UserRole)
class UserRoleAdmin(admin.ModelAdmin):
    """
    Administraci√≥n directa de la tabla intermedia user_role (opcional).
    √ötil para auditor√≠a de qui√©n asign√≥ qu√© rol.
    """
    list_display = ('user', 'role', 'assigned_by', 'assigned_at')
    list_filter = ('role', 'assigned_at')
    search_fields = ('user__email', 'role__role_name')


================================================================================

        - apps.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/users/apps.py
--------------------------------------------------------------------------------
from django.apps import AppConfig


class UsersConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'src.users'
    label = 'users'


================================================================================

        - models.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/users/models.py
--------------------------------------------------------------------------------
from django.db import models
from django.contrib.auth.models import AbstractUser, BaseUserManager
from django.utils.translation import gettext_lazy as _
from src.institutions.models import EnvironmentalInstitution


class Permission(models.Model):
    """
    Representa una acci√≥n espec√≠fica o recurso protegido en el sistema (tabla 'permission').
    
    Ejemplos: 'create_station', 'view_reports', 'validate_user'.
    """
    permission_id = models.AutoField(primary_key=True)
    permission_name = models.CharField(
        max_length=150, 
        unique=True, 
        verbose_name="Nombre del Permiso"
    )
    description = models.TextField(
        blank=True, 
        null=True, 
        verbose_name="Descripci√≥n"
    )
    created_at = models.DateTimeField(auto_now_add=True, verbose_name="Fecha de creaci√≥n")
    updated_at = models.DateTimeField(auto_now=True, verbose_name="√öltima actualizaci√≥n")

    def __str__(self) -> str:
        return self.permission_name

    class Meta:
        db_table = 'permission'
        verbose_name = 'Permiso'
        verbose_name_plural = 'Permisos'

class Role(models.Model):
    """
    Representa el rol del usuario en el sistema (relaci√≥n 'role').
    
    Define los niveles de permiso y acceso dentro de la plataforma VRISA.
    Ejemplos: Administrador, T√©cnico, Investigador.
    """
    role_id = models.AutoField(primary_key=True)
    role_name = models.CharField(max_length=100, unique=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self) -> str:
        return self.role_name
    
    class Meta:
        db_table = 'role'
        verbose_name = 'Rol'
        verbose_name_plural = 'Roles'

class CustomUserManager(BaseUserManager):
    """
    Gestor personalizado de usuarios.

    Reemplaza el comportamiento por defecto de Django para utilizar el  correo electr√≥nico (email)
    como identificador √∫nico en lugar del 'username'.
    """
    def create_user(self, email, password = None, **extra_fields):
        """
        Crea y guarda un usuario con el email y contrase√±a dados.
        """
        if not email:
            raise ValueError(_('El correo electr√≥nico es obligatorio.'))
        email = self.normalize_email(email)
        user = self.model(email=email, **extra_fields)
        user.set_password(password)
        user.save(using=self._db)
        return user

    def create_superuser(self, email, password = None, **extra_fields):
        """
        Crea y guarda un superusuario con permisos de staff y superuser.
        """
        extra_fields.setdefault('is_staff', True)
        extra_fields.setdefault('is_superuser', True)
        extra_fields.setdefault('is_active', True)

        if extra_fields.get('is_staff') is not True:
            raise ValueError(_('El superusuario debe tener is_staff=True.'))
        
        return self.create_user(email, password, **extra_fields)

class User(AbstractUser):
    """
    Modelo de Usuario personalizado para el sistema VRISA (tabla 'user').

    Extiende de AbstractUser para mantener las funcionalidades de autenticaci√≥n de Django.

    Atributos principales:
        email: Identificador √∫nico del usuario.
        job_title: Cargo laboral dentro de la instituci√≥n, es opcional.
        institution: Relaci√≥n con la entidad ambiental a la que pertenece, es opcional.
        professional_card_*: Archivos digitales de la tarjeta profesional, es opcional.
    """
    username = None
    email = models.EmailField(_('direcci√≥n de correo'), unique=True)
    job_title = models.CharField(max_length=150, blank=True, null=True)
    professional_card_front = models.ImageField(upload_to='users/cards/', blank=True, null=True)
    professional_card_rear = models.ImageField(upload_to='users/cards/', blank=True, null=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    institution = models.ForeignKey(
        EnvironmentalInstitution, 
        on_delete=models.SET_NULL, 
        null=True, 
        blank=True,
        related_name='users'
    )

    roles = models.ManyToManyField(
        Role, 
        through='UserRole',
        through_fields=('user', 'role'), 
        related_name='users',
        verbose_name="Roles asignados"
    )

    USERNAME_FIELD = 'email'
    REQUIRED_FIELDS = ['first_name', 'last_name']
    
    objects = CustomUserManager() # type: ignore
    
    def __str__(self) -> str:
        return self.email

    class Meta:
        db_table = 'user'
        verbose_name = 'Usuario'
        verbose_name_plural = 'Usuarios'

class UserRole(models.Model):
    """
    Relaci√≥n intermedia para asignar roles a los usuarios (tabla 'user_role').

    Gestiona la relaci√≥n de muchos a muchos entre Usuarios y Roles, permitiendo
    registrar qui√©n realiz√≥ la asignaci√≥n del rol (trazabilidad).
    """
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    role = models.ForeignKey(Role, on_delete=models.CASCADE)
    
    assigned_by = models.ForeignKey(
        User, 
        on_delete=models.SET_NULL, 
        null=True, 
        blank=True, 
        related_name='assigned_roles_history'
    )
    assigned_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'user_role'
        unique_together = ('user', 'role')


class RolePermission(models.Model):
    """
    Modelo intermedio para la tabla 'rol_permission' (seg√∫n diagrama).
    
    Vincula Roles con Permisos, permitiendo definir qu√© puede hacer cada rol
    y dejando registro de qu√© administrador configur√≥ ese permiso.
    """
    role = models.ForeignKey(Role, on_delete=models.CASCADE, verbose_name="Rol")
    permission = models.ForeignKey(Permission, on_delete=models.CASCADE, verbose_name="Permiso")
    
    # Campo requerido por el diagrama: granted_by
    granted_by = models.ForeignKey(
        User, 
        on_delete=models.SET_NULL, 
        null=True, 
        blank=True, 
        related_name='granted_permissions_history',
        verbose_name="Otorgado por"
    )
    
    granted_at = models.DateTimeField(auto_now_add=True, verbose_name="Fecha de otorgamiento")

    class Meta:
        db_table = 'rol_permission'
        unique_together = ('role', 'permission')
        verbose_name = 'Permiso de Rol'
        verbose_name_plural = 'Permisos de Roles'

================================================================================

        - serializers.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/users/serializers.py
--------------------------------------------------------------------------------
from rest_framework import serializers
from rest_framework_simplejwt.serializers import TokenObtainPairSerializer
from src.users.models import User, Role
from src.institutions.models import EnvironmentalInstitution


class InstitutionSerializer(serializers.ModelSerializer):
    """
    Serializador para mostrar informaci√≥n b√°sica de la instituci√≥n dentro de las respuestas de usuario.
    """
    class Meta:
        model = EnvironmentalInstitution
        fields = ['institution_id', 'institute_name']

class RoleSerializer(serializers.ModelSerializer):
    """
    Serializador para listar los roles disponibles o asignados.
    """
    class Meta:
        model = Role
        fields = ['role_id', 'role_name']

class UserSerializer(serializers.ModelSerializer):
    """
    Serializador para leer datos de Usuario (Salida).
    Incluye objetos anidados completos para 'institution' y 'roles'.
    """
    institution = InstitutionSerializer(read_only=True)
    roles = RoleSerializer(many=True, read_only=True) 

    class Meta:
        model = User
        fields = [
            'id', 'email', 'first_name', 'last_name', 
            'job_title', 'institution', 'roles', 
            'professional_card_front', 'professional_card_rear',
            'is_active', 'created_at'
        ]

class RegisterUserSerializer(serializers.Serializer):
    """
    Serializador para validaci√≥n de entrada durante el registro.

    Maneja la validaci√≥n de:
    1. Unicidad del correo electr√≥nico.
    2. Existencia de la instituci√≥n seleccionada.
    3. Recepci√≥n de archivos (tarjeta profesional).
    """
    email = serializers.EmailField()
    password = serializers.CharField(write_only=True, min_length=6)
    first_name = serializers.CharField(max_length=150)
    last_name = serializers.CharField(max_length=150)
    role_id = serializers.IntegerField(required=False, allow_null=True)
    institution_id = serializers.IntegerField(required=False, allow_null=True)

    job_title = serializers.CharField(max_length=150, required=False)
    professional_card_front = serializers.ImageField(required=False)
    professional_card_rear = serializers.ImageField(required=False)

    def validate_email(self, value):
        """
        Verifica que el correo no est√© registrado previamente.
        """
        if User.objects.filter(email=value).exists():
            raise serializers.ValidationError("Ya existe un usuario con este correo electr√≥nico.")
        return value
    
    def validate_institution_id(self, value):
        if value is None:
            return None
        """
        Verifica que la instituci√≥n referenciada exista en la base de datos.
        """
        if not EnvironmentalInstitution.objects.filter(pk=value).exists():
            raise serializers.ValidationError("La instituci√≥n seleccionada no existe.")
        return value

class CustomTokenObtainPairSerializer(TokenObtainPairSerializer):
    """
    Personaliza el payload del token JWT para incluir informaci√≥n contextual
    del usuario (Rol, Instituci√≥n, Nombre) directamente en el token cifrado.
    """
    @classmethod
    def get_token(cls, user):
        token = super().get_token(user)

        # Agregar datos personalizados al token
        token['email'] = user.email
        token['full_name'] = f"{user.first_name} {user.last_name}"
        
        # Agregar Instituci√≥n (si tiene)
        if user.institution:
            token['institution_id'] = user.institution.id
            token['institution_name'] = user.institution.institute_name
        else:
            token['institution_id'] = None
        
        # Agregar Roles
        token['primary_role'] = cls.get_primary_role(user)
        token['roles_list'] = list(user.roles.values_list('role_name', flat=True))

        return token
        

    @staticmethod
    def get_primary_role(user):
        """M√©todo auxiliar para centralizar la l√≥gica del rol"""
        if user.is_superuser:
            return 'super_admin'
        elif user.is_staff:
            return 'staff'
        
        # Busca el primer rol en la base de datos, si existen roles registrados
        if user.roles.exists():
            return user.roles.first().role_name.lower()
        
        return 'citizen'

================================================================================

        - services.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/users/services.py
--------------------------------------------------------------------------------
from django.db import transaction
from django.shortcuts import get_object_or_404
from src.users.models import User, Role
from src.institutions.models import EnvironmentalInstitution

def create_user(validated_data: dict) -> User:
    """
    L√≥gica de negocio para registrar un nuevo usuario en VRISA.
    
    Proceso:
    1. Extrae los datos validados.
    2. Inicia una transacci√≥n at√≥mica para asegurar integridad.
    3. Vincula el usuario a la Instituci√≥n especificada.
    4. Guarda los archivos de la tarjeta profesional si se proporcionan.
    5. Crea el usuario con 'is_active=False' (esperando validaci√≥n de admin).
    
    Args:
        validated_data (dict): Diccionario con datos ya validados por el serializador.
        
    Returns:
        User: Instancia del usuario creado.
    """
    email = validated_data['email']
    password = validated_data['password']
    first_name = validated_data['first_name']
    last_name = validated_data['last_name']
    job_title = validated_data.get('job_title', '')
    institution_id = validated_data.get('institution_id')
    
    card_front = validated_data.get('professional_card_front')
    card_rear = validated_data.get('professional_card_rear')

    # transaccion para crear el usuario y asignar un rol por defecto hasta que un admin que lo verifique
    with transaction.atomic():
        institution = None
        if institution_id:
            institution = get_object_or_404(EnvironmentalInstitution, pk=institution_id)

        user = User.objects.create_user(
            email=email,
            password=password,
            first_name=first_name,
            last_name=last_name,
            job_title=job_title,
            institution=institution,
            professional_card_front=card_front,
            professional_card_rear=card_rear,
            is_active=True  # Activo por defecto
        ) # type: ignore

    return user

def get_user_by_id(user_id: int) -> User:
    """
    M√©todo para obtener un usuario por su ID.
    Lanza Http404 si no se encuentra.
    """
    user = get_object_or_404(User, pk=user_id)
    return user

def get_total_users_count() -> int:
    """
    Retorna el n√∫mero total de usuarios registrados en el sistema.
    """
    return User.objects.count()


================================================================================

        - tests.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/users/tests.py
--------------------------------------------------------------------------------
from django.test import TestCase
from django.core.exceptions import ValidationError
from src.users.services import create_user
from src.users.models import User
from src.institutions.models import EnvironmentalInstitution

class UserServiceTestCase(TestCase):
    def setUp(self):
        # Crear datos previos necesarios
        self.institution = EnvironmentalInstitution.objects.create(
            institute_name="Vrisa Corp",
            physic_address="Calle 123"
        )

    def test_create_user_service_success(self):
        """
        Prueba que el servicio crea un usuario y lo vincula a la instituci√≥n
        correctamente, adem√°s de aplicar las reglas de negocio.
        """
        data = {
            'email': 'test@vrisa.com',
            'password': 'password123',
            'first_name': 'Juan',
            'last_name': 'Perez',
            'institution_id': self.institution.id,
            'job_title': 'Analista'
        }
        
        user = create_user(data)
        
        self.assertEqual(user.email, 'test@vrisa.com')
        self.assertEqual(user.institution, self.institution)
        self.assertFalse(user.is_active) # Regla de negocio: nace inactivo
        self.assertTrue(user.check_password('password123'))

    def test_create_user_invalid_institution(self):
        """
        Prueba que falla si la instituci√≥n no existe (manejado por get_object_or_404)
        """
        data = {
            'email': 'fail@vrisa.com',
            'password': '123',
            'first_name': 'Fail',
            'last_name': 'User',
            'institution_id': 9999 # ID inexistente
        }
        
        # get_object_or_404 lanza Http404, en tests puros a veces queremos capturar eso
        # o asegurarnos que el servicio lo maneje.
        from django.http import Http404
        with self.assertRaises(Http404):
            create_user(data)

================================================================================

        - urls.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/users/urls.py
--------------------------------------------------------------------------------
from django.urls import path
from rest_framework_simplejwt.views import TokenRefreshView
from src.users.views import CustomTokenObtainPairView, UserDetailView, UserRegistrationView, UserStatsView

urlpatterns = [
    # Autenticaci√≥n (JWT)
    path('login/', CustomTokenObtainPairView.as_view(), name='token_obtain_pair'),
    path('token/refresh/', TokenRefreshView.as_view(), name='token_refresh'),
    
    # Gesti√≥n de Usuarios
    path('register/', UserRegistrationView.as_view(), name='user-register'),
    path('<int:user_id>/', UserDetailView.as_view(), name='user-detail'),
    path('stats/', UserStatsView.as_view(), name='user-stats'),
]

================================================================================

        - views.py
--------------------------------------------------------------------------------
// Ruta del archivo: src/users/views.py
--------------------------------------------------------------------------------
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status, permissions
from rest_framework_simplejwt.views import TokenObtainPairView
from rest_framework.decorators import api_view, permission_classes
from src.users.models import User
from src.users.serializers import CustomTokenObtainPairSerializer, RegisterUserSerializer, UserSerializer
import src.users.services as user_services

class CustomTokenObtainPairView(TokenObtainPairView):
    """
    Endpoint de Login.
    Recibe email y password, retorna Access Token y Refresh Token.
    Usa el serializador personalizado para inyectar claims extra.
    """
    serializer_class = CustomTokenObtainPairSerializer

class UserRegistrationView(APIView):
    permission_classes = [permissions.AllowAny] 
    def post(self, request):
        print("Data recibida:", request.data)
        # 1. Validar Entrada
        input_serializer = RegisterUserSerializer(data=request.data)
        if input_serializer.is_valid():
            try:
                # 2. Llamar a la l√≥gica de negocio (Servicio)
                created_user = user_services.create_user(input_serializer.validated_data)
                
                # 3. Formatear Salida
                output_serializer = UserSerializer(created_user)
                return Response(output_serializer.data, status=status.HTTP_201_CREATED)
            
            except Exception as e:
                print(f"Error interno: {str(e)}")
                return Response(
                    {'error': 'Error interno del servidor', 'details': str(e)}, 
                    status=status.HTTP_500_INTERNAL_SERVER_ERROR
                )
        print("Errores:", input_serializer.errors)
        return Response(input_serializer.errors, status=status.HTTP_400_BAD_REQUEST)

class UserDetailView(APIView):
    def get(self, request, user_id: int):
        # El servicio maneja la l√≥gica de "No encontrado" (404) internamente
        user = user_services.get_user_by_id(user_id)
        serializer = UserSerializer(user)
        return Response(serializer.data, status=status.HTTP_200_OK)

class UserStatsView(APIView):
    """
    Endpoint para obtener estad√≠sticas generales de usuarios.
    Solo accesible por administradores.
    """
    permission_classes = [permissions.IsAdminUser]

    def get(self, request):
        try:
            total_count = user_services.get_total_users_count()
            return Response({'total_users': total_count}, status=status.HTTP_200_OK)
        except Exception as e:
            return Response(
                {'error': 'Error obteniendo estad√≠sticas', 'details': str(e)}, 
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

================================================================================

